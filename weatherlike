var http 		= 	require('http');
var https 		= 	require('https');

var qs 			= 	require('querystring');
var htmlparser2 = 	require('htmlparser2');

var LRU 		=	require('lru-cache');

var woeidurl	=	"http://woeid.rosselliot.co.nz/lookup/";
var yahoo 		= 	"https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20weather.forecast%20where%20woeid%3D$&format=json&callback=";


var CACHE_LIMIT = 	1000;
var idCache 	= 	LRU(CACHE_LIMIT);

var VERBOSE 	= 	process.env.VERBOSE;




var woeid = "";
var firstwoeid = true;
var parser = new htmlparser2.Parser({
	onattribute: function(name, value){
		if (firstwoeid && name === "data-woeid")
			{
				woeid = value;
				firstwoeid = false;
				parser.end();
			}
	}
});


function getWoeid(city, callback){
	http.get(woeidurl+qs.escape(city), function(response){
		response.on('data', function(data){
			parser.write(data);
		});
		response.on('end', function(){
			parser.end();
			if(VERBOSE)
				console.log("woeid found is %s", woeid);
			if (!idCache.has(city)){
				idCache.set(city, woeid);	//	cache the <city, woeid>
				if (VERBOSE) {
					console.log("%s has been cached", city);
					console.log("idCache now has length of %s", idCache.keys().length);
				}
			}
			var url = getYahooURLFromWoeid(woeid);
			getWeather(null, url, callback);
		});
	});
}

function getYahooURLFromWoeid(woeid){
	return yahoo.replace("$", woeid);
}

function getWeather(err, yahoo, callback){
	https.get(yahoo, function(response){
		var weather = "";
		response.on('data', function(data){
			weather += data;
		});
		response.on('end', function(){
			var json = JSON.parse(weather);
			if(json.query)
				callback(null, {'woeid' : woeid, 'forecast' : json.query.results.channel.item.forecast});
			else
				callback(true, null);

			woeid = "";
			firstwoeid = true;

		});
	});
}

function inCity(city, callback){
	if(idCache.has(city))	//	try to save time using the cache
		{
			if(VERBOSE){
				console.log("City %s found in cache!", city);
				console.log("woeid : %s", idCache.peek(city));
			}
			getWeather(null, getYahooURLFromWoeid(idCache.get(city)), callback);
		}
	else
		{
			if(VERBOSE){console.log("%s not cached yet", city);}
			getWoeid(city, callback);

		}
}

function inWoeid(woeid, callback){
	https.get(getYahooURLFromWoeid(woeid), function(response){
		var weather = "";
		response.on('data', function(data){
			weather += data;
		});
		response.on('end', function(){
			var json = JSON.parse(weather);
			if(json.query)
				callback(null, {'woeid' : woeid, 'forecast' : json.query.results.channel.item.forecast});
			else
				callback(true, null);
		});
	});
}

module.exports.inCity = inCity;
module.exports.inWoeid = inWoeid;